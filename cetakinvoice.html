<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoice | Sedulur Foto Copy</title>

<link rel="icon" href="img/loggo/sdlr.png">
<link rel="stylesheet" href="css/invoce.css">
</head>
<body>

<!-- ===== NAVBAR ===== -->
<header>
  <div class="logo">
    <img src="img/loggo/sdlr.png">
  </div>
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="cetakfoto.html">Cetak Foto</a></li>
      <li><a href="cetakinvoice.html">Invoice</a></li>
      <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
  </nav>
</header>

<!-- ===== HEADER INVOICE ===== -->
<div class="header" id="notaArea">
  <img src="img/loggo/logo1.png" class="logo">
  <div class="info">
    <small>Tanggal: <span id="tgl"></span></small><br>
    <small>No Nota: <span id="noNota"></span></small><br>
    <small>Pelanggan: <span id="namaView">-</span></small><br>
    <small>Admin: <span id="adminName">-</span></small>
  </div>
</div>

<!-- ===== INPUT ===== -->
<div class="no-print">
  <input type="text" id="namaPelanggan" placeholder="Nama Pelanggan">
</div>

<div class="select-area no-print">
<select id="layanan">
  <!-- PRINT -->
  <option value="300" data-type="print">Print Hitam Putih</option>
  <option value="500" data-type="print">Print Warna</option>
  <option value="500" data-type="print">HP Bolak Balik</option>

  <!-- KERTAS -->
  <option value="4000" data-type="print">A4 HVS</option>
  <option value="8000" data-type="print">A3 Buffalo</option>
  <option value="10000" data-type="print">A3 Glossy</option>

  <!-- JILID -->
  <option value="40000" data-type="jilid">Hardcover</option>
  <option value="4000" data-type="jilid">Jilid Mika</option>
  <option value="15000" data-type="jilid">Softcover</option>
  <option value="18000" data-type="jilid">Softcover Sambung</option>
</select>

<input type="number" id="lembar" value="1" min="1">
<input type="number" id="qty" value="1" min="1">
<button onclick="tambah()">Tambah</button>
</div>

<!-- ===== TABLE ===== -->
<table>
<thead>
<tr>
  <th>Deskripsi</th>
  <th class="print-only">Harga</th>
  <th>Lembar</th>
  <th>Qty</th>
  <th class="print-only">Subtotal</th>
  <th class="no-print">Aksi</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<!-- ===== TOTAL ===== -->
<div class="total">Total: Rp <span id="totalView">0</span></div>
<div class="total">Diskon: Rp <span id="discountView">0</span></div>
<div class="grand-total">Grand Total: Rp <span id="grandTotalView">0</span></div>

<!-- ===== DISKON ADMIN ===== -->
<div class="no-print">
<button onclick="toggleDiscount()">Aktifkan Diskon Admin</button>
<small id="discountStatus">Diskon nonaktif</small>
</div>

<!-- ===== BUTTON ===== -->
<div class="no-print" style="display:flex;gap:10px">
<button onclick="window.print()">Print</button>
<button onclick="downloadPDF()">PDF</button>
<button onclick="sendWA()">WhatsApp</button>
<button onclick="location.reload()">Reset</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- ===== SCRIPT ===== -->
<script>
const layanan = document.getElementById("layanan");
const lembarInput = document.getElementById("lembar");
const qtyInput = document.getElementById("qty");
const list = document.getElementById("list");
const totalView = document.getElementById("totalView");
const discountView = document.getElementById("discountView");
const grandTotalView = document.getElementById("grandTotalView");
const namaView = document.getElementById("namaView");
const namaPelanggan = document.getElementById("namaPelanggan");
const discountStatus = document.getElementById("discountStatus");

let discountEnabled = false;
const ADMIN_PASSWORD = "1234";

document.getElementById("noNota").innerText = "INV-" + Date.now();
const d = new Date();
document.getElementById("tgl").innerText =
`${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;

namaPelanggan.oninput = () =>
namaView.innerText = namaPelanggan.value || "-";

layanan.onchange = () => {
  const type = layanan.selectedOptions[0].dataset.type;
  if(type === "jilid"){
    lembarInput.value = 1;
    lembarInput.disabled = true;
  } else {
    lembarInput.disabled = false;
  }
};

function toggleDiscount(){
  if(prompt("Password admin:") !== ADMIN_PASSWORD){
    alert("Password salah");
    return;
  }
  discountEnabled = !discountEnabled;
  discountStatus.innerText = discountEnabled
    ? "Diskon 7% AKTIF (â‰¥200rb)"
    : "Diskon nonaktif";
  hitung();
}

function tambah(){
  const opt = layanan.selectedOptions[0];
  const harga = +opt.value;
  const type = opt.dataset.type;
  const qty = +qtyInput.value;
  const lembar = type === "jilid" ? 1 : +lembarInput.value;

  const sub = type === "jilid"
    ? harga * qty
    : harga * lembar * qty;

  const tr = document.createElement("tr");
  tr.dataset.sub = sub;

  tr.innerHTML = `
    <td>${opt.text}</td>
    <td class="print-only">${harga.toLocaleString()}</td>
    <td>${type === "jilid" ? "-" : lembar}</td>
    <td>${qty}</td>
    <td class="print-only">${sub.toLocaleString()}</td>
    <td class="no-print">
      <span onclick="this.closest('tr').remove(); hitung()">Hapus</span>
    </td>
  `;
  list.appendChild(tr);
  hitung();
}

function hitung(){
  let total = 0;
  document.querySelectorAll("#list tr").forEach(tr=>{
    total += +tr.dataset.sub;
  });

  let discount = 0;
  if(discountEnabled && total >= 200000){
    discount = Math.floor(total * 0.07);
  }

  totalView.innerText = total.toLocaleString();
  discountView.innerText = discount.toLocaleString();
  grandTotalView.innerText = (total - discount).toLocaleString();
}

function downloadPDF(){
  html2pdf().from(document.getElementById("notaArea")).save();
}

function sendWA(){
  window.open(`https://wa.me/6288980484642?text=${encodeURIComponent(
    "Invoice Sedulur Fotocopy\n" +
    "Admin: " + document.getElementById("adminName").innerText +
    "\nPelanggan: " + namaView.innerText +
    "\nGrand Total: Rp " + grandTotalView.innerText
  )}`);
}
</script>

<!-- ===== FIREBASE ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
  apiKey: "AIzaSyCzk9nMICnFTHaF8_xvGoWuyUuKiP-dS1Y",
  authDomain: "sedulur-fotocopy-unnes.firebaseapp.com",
  projectId: "sedulur-fotocopy-unnes"
});
const auth = getAuth(app);

onAuthStateChanged(auth, user=>{
  if(!user) location.href="login.html";
  else document.getElementById("adminName").innerText = user.email;
});

window.logout = ()=>signOut(auth).then(()=>location.href="login.html");
</script>

</body>
</html>
